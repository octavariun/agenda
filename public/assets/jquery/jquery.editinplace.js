(function(t){function e(t,e){this.settings=t,this.dom=e,this.originalValue=null,this.didInsertDefaultText=!1,this.shouldDelayReinit=!1}function i(t){if(!t.url&&!t.callback)throw new Error("Need to set either url: or callback: option for the inline editor to work.")}function n(t){if(""!==t){var e=new Image;e.src=t}}function s(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")}function a(t){return void 0===t||null===t?!1:0===t.length?!1:!0}t.fn.editInPlace=function(s){var a=t.extend({},t.fn.editInPlace.defaults,s);return i(a),n(a.saving_image),this.each(function(){var i=t(this);i.data("editInPlace")||(i.data("editInPlace",!0),new e(a,i).init())})},t.fn.editInPlace.defaults={url:"",ajax_data_type:"html",bg_over:"#ffc",bg_out:"transparent",hover_class:"",show_buttons:!1,save_button:'<button class="inplace_save">Save</button>',cancel_button:'<button class="inplace_cancel">Cancel</button>',params:"",field_type:"text",default_text:"(Click here to add text)",use_html:!1,textarea_rows:10,textarea_cols:25,select_text:"Choose new value",select_options:"",text_size:null,editor_url:null,loading_text:"Loading...",saving_text:void 0,saving_image:"",saving_animation_color:"transparent",clone_selector:null,clone_id_suffix:null,value_required:!1,element_id:"element_id",update_value:"update_value",original_value:"original_value",original_html:"original_html",save_if_nothing_changed:!1,on_blur:"save",cancel:"",callback:null,callback_skip_dom_reset:!1,beforeSend:null,success:null,error:null,error_sink:function(t,e){alert(e)},preinit:null,postclose:null,delegate:null},t.extend(e.prototype,{init:function(){this.setDefaultTextIfNeccessary(),this.connectOpeningEvents()},reinit:function(){this.shouldDelayReinit||(this.triggerCallback(this.settings.postclose,this.dom),this.triggerDelegateCall("didCloseEditInPlace"),this.markEditorAsInactive(),this.connectOpeningEvents())},setDefaultTextIfNeccessary:function(){""===this.dom.html()&&(this.dom.html(this.settings.default_text),this.didInsertDefaultText=!0)},connectOpeningEvents:function(){var t=this;this.dom.bind("mouseenter.editInPlace",function(){t.addHoverEffect()}).bind("mouseleave.editInPlace",function(){t.removeHoverEffect()}).bind("click.editInPlace",function(e){t.openEditor(e)})},disconnectOpeningEvents:function(){this.dom.unbind(".editInPlace")},addHoverEffect:function(){this.settings.hover_class?this.dom.addClass(this.settings.hover_class):this.dom.css("background-color",this.settings.bg_over)},removeHoverEffect:function(){this.settings.hover_class?this.dom.removeClass(this.settings.hover_class):this.dom.css("background-color",this.settings.bg_out)},openEditor:function(t){this.shouldOpenEditor(t)&&(this.disconnectOpeningEvents(),this.removeHoverEffect(),this.removeInsertedDefaultTextIfNeccessary(),this.saveOriginalValue(),this.markEditorAsActive(),this.replaceContentWithEditor(),this.setInitialValue(),this.workAroundMissingBlurBug(),this.connectClosingEventsToEditor(),this.triggerDelegateCall("didOpenEditInPlace"))},shouldOpenEditor:function(t){return this.isClickedObjectCancelled(t.target)?!1:!1===this.triggerCallback(this.settings.preinit,this.dom)?!1:!1===this.triggerDelegateCall("shouldOpenEditInPlace",!0,t)?!1:!0},removeInsertedDefaultTextIfNeccessary:function(){this.didInsertDefaultText&&this.dom.html()===this.settings.default_text&&(this.dom.html(""),this.didInsertDefaultText=!1)},isClickedObjectCancelled:function(e){if(!this.settings.cancel)return!1;var i=t(e).parents().andSelf(),n=i.filter(this.settings.cancel);return 0!==n.length},saveOriginalValue:function(){this.originalValue=this.settings.use_html?this.dom.html():s(this.dom.text())},restoreOriginalValue:function(){this.setClosedEditorContent(this.originalValue)},setClosedEditorContent:function(t){this.settings.use_html?this.dom.html(t):this.dom.text(t)},workAroundMissingBlurBug:function(){var t=this.dom.find(":input");this.dom.parents(":last").find(".editInPlace-active :input").not(t).blur()},replaceContentWithEditor:function(){var t=this.settings.show_buttons?this.settings.save_button+" "+this.settings.cancel_button:"",e=this.createEditorElement();this.dom.html('<form class="inplace_form" style="display: inline; margin: 0; padding: 0;"></form>').find("form").append(e).append(t)},createEditorElement:function(){if(-1===t.inArray(this.settings.field_type,["text","textarea","select","remote","clone"]))throw"Unknown field_type <fnord>, supported are 'text', 'textarea', 'select' and 'remote'";var e=null;if("select"===this.settings.field_type)e=this.createSelectEditor();else if("text"===this.settings.field_type)e=t('<input type="text" '+this.inputNameAndClass()+' size="'+this.settings.text_size+'" />');else if("textarea"===this.settings.field_type)e=t("<textarea "+this.inputNameAndClass()+' rows="'+this.settings.textarea_rows+'" '+' cols="'+this.settings.textarea_cols+'" />');else if("remote"===this.settings.field_type)e=this.createRemoteGeneratedEditor();else if("clone"===this.settings.field_type)return e=this.cloneEditor();return e},setInitialValue:function(){if("remote"!=this.settings.field_type&&"clone"!=this.settings.field_type){var t=this.triggerDelegateCall("willOpenEditInPlace",this.originalValue),e=this.dom.find(":input");e.val(t),e.val()!==t&&e.val("")}},createRemoteGeneratedEditor:function(){return this.dom.html(this.settings.loading_text),t(t.ajax({url:this.settings.editor_url,async:!1}).responseText)},cloneEditor:function(){var e=this.getPatternNodes(this.settings.clone_selector);if(null==e.editNode)return alert("did not find any matching node for "+this.settings.clone_selector),void 0;var i=e.editNode.clone(),n=null;return i.attr("id")&&i.attr("id",i.attr("id")+this.settings.clone_id_suffix),i.attr("name","inplace_value"),i.addClass("editor_field"),this.setValue(i,this.originalValue),n=i,e.additionalNodes&&e.additionalNodes.each(function(e,i){var s=t(i).clone();s.attr("id")&&s.attr("id",s.attr("id")+this.settings.clone_id_suffix),n=n.after(s)}),n},getPatternNodes:function(e){var i={editNode:null,additionalNodes:null},n=t(e),s=n.first();return"undefined"!=typeof s&&(s.hasClass("as_inplace_pattern")&&(n=s.children()),i.editNode=n.first(),i.additionalNodes=n.slice(1)),i},setValue:function(t,e){var i="setValueFor"+t.get(0).nodeName.toLowerCase();"function"==typeof this[i]?this[i](t,e):t.val(e)},setValueForselect:function(t,e){var i=t.children("option:contains('"+e+"')").val();"undefined"!=typeof i&&t.val(i)},inputNameAndClass:function(){return' name="inplace_value" class="inplace_field" '},createSelectEditor:function(){var e=t("<select"+this.inputNameAndClass()+">"+'<option disabled="true" value="">'+this.settings.select_text+"</option>"+"</select>"),i=this.settings.select_options;t.isArray(i)||(i=i.split(","));for(var n=0;i.length>n;n++){var a=i[n];t.isArray(a)||(a=a.split(":"));var l=s(a[1]||a[0]),o=s(a[0]),r=t("<option>").val(l).text(o);e.append(r)}return e},connectClosingEventsToEditor:function(){function t(t){return i.handleCancelEditor(t),!1}function e(t){return i.handleSaveEditor(t),!1}var i=this,n=this.dom.find("form");n.find(".inplace_field").focus().select(),n.find(".inplace_cancel").click(t),n.find(".inplace_save").click(e),this.settings.show_buttons||("save"===this.settings.on_blur?n.find(".inplace_field").blur(e):n.find(".inplace_field").blur(t)),n.keyup(function(e){var i=27;return i===e.which?t():void 0}),n.submit(e)},bindSubmitOnEnterInInput:function(){if("textarea"!==this.settings.field_type){var t=this;this.dom.find(":input").keyup(function(e){var i=13;return i===e.which?t.dom.find("form").submit():void 0})}},handleCancelEditor:function(t){if(!1!==this.triggerDelegateCall("shouldCloseEditInPlace",!0,t)){var e=this.dom.find(":input"),i=e.val();i=this.triggerDelegateCall("willCloseEditInPlace",i),this.restoreOriginalValue(),this.reinit()}},handleSaveEditor:function(e){if(!1!==this.triggerDelegateCall("shouldCloseEditInPlace",!0,e)){var i=this.dom.find('[name]:input:not(:button,[name=""])').not("input:checkbox:not(:checked)").not("input:radio:not(:checked)"),n="";if(n=i.length>1?jQuery.map(i,function(e){return t(e).val()}):i.val(),n=this.triggerDelegateCall("willCloseEditInPlace",n),this.isDisabledDefaultSelectChoice()||this.isUnchangedInput(n))return this.handleCancelEditor(e),void 0;if(this.didForgetRequiredText(n))return this.handleCancelEditor(e),this.reportError("Error: You must enter a value to save this field"),void 0;this.showSaving(n),this.settings.callback?this.handleSubmitToCallback(n):this.handleSubmitToServer(n)}},didForgetRequiredText:function(t){return this.settings.value_required&&(""===t||void 0===t||null===t)},isDisabledDefaultSelectChoice:function(){return this.dom.find("option").eq(0).is(":selected:disabled")},isUnchangedInput:function(t){return!this.settings.save_if_nothing_changed&&this.originalValue===t},showSaving:function(e){if(!this.settings.callback||!this.settings.callback_skip_dom_reset){var i=e;a(this.settings.saving_text)&&(i=this.settings.saving_text),a(this.settings.saving_image)&&(i=t("<img />").attr("src",this.settings.saving_image).attr("alt",i)),this.dom.html(i)}},handleSubmitToCallback:function(t){this.enableOrDisableAnimationCallbacks(!0,!1);var e=this.triggerCallback(this.settings.callback,this.id(),t,this.originalValue,this.settings.params,this.savingAnimationCallbacks());this.settings.callback_skip_dom_reset||(void 0===e?(this.reportError("Error: Failed to save value: "+t),this.restoreOriginalValue()):this.dom.html(e)),this.didCallNoCallbacks()&&(this.enableOrDisableAnimationCallbacks(!1,!1),this.reinit())},handleSubmitToServer:function(e){var i="";if("string"==typeof e)i+=this.settings.update_value+"="+encodeURIComponent(e)+"&";else for(var n=0;e.length>n;n++)i+=this.settings.update_value+"[]="+encodeURIComponent(e[n])+"&";i+=this.settings.element_id+"="+this.dom.attr("id")+(this.settings.params?"&"+this.settings.params:"")+"&"+this.settings.original_html+"="+encodeURIComponent(this.originalValue)+"&"+this.settings.original_value+"="+encodeURIComponent(this.originalValue),this.enableOrDisableAnimationCallbacks(!0,!1),this.didStartSaving();var s=this;t.ajax({url:s.settings.url,type:"POST",data:i,dataType:s.settings.ajax_data_type,beforeSend:function(t,e){s.triggerCallback(s.settings.beforeSend,t,e)},complete:function(){s.didEndSaving()},success:function(t){if("html"==s.settings.ajax_data_type){var e=t||s.settings.default_text;s.dom.html(e)}s.triggerCallback(s.settings.success,t)},error:function(t){s.dom.html(s.originalHTML),s.settings.error?s.triggerCallback(s.settings.error,t):s.reportError("Failed to save value: "+t.responseText||"Unspecified Error")}})},triggerCallback:function(t){if(t){var e=Array.prototype.slice.call(arguments,1);return t.apply(this.dom[0],e)}},triggerDelegateCall:function(e,i,n){if(!this.settings.delegate||!t.isFunction(this.settings.delegate[e]))return i;var s=this.settings.delegate[e](this.dom,this.settings,n);return void 0===s?i:s},reportError:function(t){this.triggerCallback(this.settings.error_sink,this.id(),t)},id:function(){return this.dom.attr("id")},markEditorAsActive:function(){this.dom.addClass("editInPlace-active")},markEditorAsInactive:function(){this.dom.removeClass("editInPlace-active")},savingAnimationCallbacks:function(){var t=this;return{didStartSaving:function(){t.didStartSaving()},didEndSaving:function(){t.didEndSaving()}}},enableOrDisableAnimationCallbacks:function(t,e){this.didStartSaving.enabled=t,this.didEndSaving.enabled=e},didCallNoCallbacks:function(){return this.didStartSaving.enabled&&!this.didEndSaving.enabled},assertCanCall:function(t){if(!this[t].enabled)throw new Error("Cannot call "+t+" now. See documentation for details.")},didStartSaving:function(){this.assertCanCall("didStartSaving"),this.shouldDelayReinit=!0,this.enableOrDisableAnimationCallbacks(!1,!0),this.startSavingAnimation()},didEndSaving:function(){this.assertCanCall("didEndSaving"),this.shouldDelayReinit=!1,this.enableOrDisableAnimationCallbacks(!1,!1),this.reinit(),this.stopSavingAnimation()},startSavingAnimation:function(){var t=this;this.dom.animate({backgroundColor:this.settings.saving_animation_color},400).animate({backgroundColor:"transparent"},400,"swing",function(){setTimeout(function(){t.startSavingAnimation()},10)})},stopSavingAnimation:function(){this.dom.stop(!0).css({backgroundColor:""})},missingCommaErrorPreventer:""})})(jQuery);